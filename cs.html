<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2300897b' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z'/%3E%3Cpath fill='%2300897b' d='M15 9h-2V7h-2v2H9v2h2v2h2v-2h2z'/%3E%3C/svg%3E" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ™ºèƒ½å¯¼è¯Š - åŒ»ä¿¡é€š</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="app-layout">
      <aside class="app-sider">
        <div class="logo">
          <h2>åŒ»ä¿¡é€š</h2>
          <button class="trigger" onclick="toggleSider()">æ”¶èµ·</button>
        </div>
        <nav class="menu">
          <ul>
            <li class="menu-item">
              <a href="index.html">
                <span class="icon">ğŸ </span>
                <span class="label">ä»ªè¡¨ç›˜</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="document.html">
                <span class="icon">ğŸ“„</span>
                <span class="label">æ™ºèƒ½æ–‡æ¡£å·¥ä½œå°</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="report.html">
                <span class="icon">â•</span>
                <span class="label">åŒ»ç–—è¯Šæ–­æŠ¥å‘Š</span>
              </a>
            </li>
            <li class="menu-item active">
              <a href="guide.html">
                <span class="icon">ğŸ’¬</span>
                <span class="label">æ™ºèƒ½å¯¼è¯Š</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>
      
      <div class="main-content">
   
        
        <main class="app-content">
          <div class="ai-guide">
            <h1>æ™ºèƒ½å¯¼è¯Š</h1>
            
            <div class="card">
              <div class="guide-intro">
                <div class="guide-info-box">
                  <p class="guide-info-text">ğŸ’¡ <strong>æ™ºèƒ½å¯¼è¯ŠæœåŠ¡è¯´æ˜ï¼š</strong></p>
                  <ul class="guide-info-list">
                    <li>è¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶ã€æŒç»­æ—¶é—´å’Œç›¸å…³ä¸é€‚</li>
                    <li>ç³»ç»Ÿå°†æ ¹æ®æ‚¨æä¾›çš„ä¿¡æ¯æ¨èåˆé€‚çš„ç§‘å®¤</li>
                    <li>æœ€ç»ˆè¯Šæ–­è¯·ä»¥åŒ»ç”Ÿé¢è¯Šç»“æœä¸ºå‡†</li>
                    <li>è¯·å°½é‡è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶ã€æŒç»­æ—¶é—´å’Œç›¸å…³ä¸é€‚</li>
                  </ul>
                </div>
              </div>
              
              <div class="chat-container modern-chat-container">
                <div class="chat-header">
                  <h3>ğŸ¤– æ™ºèƒ½å¯¼è¯ŠåŠ©æ‰‹</h3>
                  <button class="new-chat-btn" onclick="startNewChat()">ğŸ†• æ–°å¯¹è¯</button>
                </div>
                <div class="chat-messages" id="chatMessages">
                  <div class="welcome-message">
                    <div class="welcome-avatar">âš•ï¸</div>
                    <div class="welcome-text">
                      <h4>æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å¯¼è¯Šç³»ç»Ÿ</h4>
                      <p>è¯·æè¿°æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ‘å°†ä¸ºæ‚¨æ¨èåˆé€‚çš„ç§‘å®¤ã€‚</p>
                    </div>
                  </div>
                </div>
                <div class="chat-input-container">
                  <div class="chat-input">
                    <textarea 
                      id="messageInput" 
                      placeholder="è¯·è¾“å…¥æ‚¨çš„ç—‡çŠ¶æè¿°..."
                      rows="1"
                      onkeypress="handleKeyPress(event)"></textarea>
                    <div class="input-actions">
                      <button id="voiceCallButton" class="action-btn voice-call-btn" title="è¯­éŸ³é€šè¯">
                        ğŸ“ è¯­éŸ³é€šè¯
                      </button>
                      <button id="voiceButton" class="action-btn voice-btn" title="è¯­éŸ³è¾“å…¥">
                        ğŸ¤ è¯­éŸ³è¾“å…¥
                      </button>
                      <button class="action-btn upload-btn" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ æ–‡ä»¶">
                  ğŸ“ æ–‡ä»¶ä¸Šä¼ 
                </button>
                      <input type="file" id="fileInput" class="hidden" onchange="handleFileUpload(event)" accept="image/*,application/pdf,.doc,.docx,.txt">
                      <button id="sendButton" class="send-btn" onclick="sendMessage()">
                        ğŸš€ å‘é€
                      </button>
                    </div>
                  </div>
                  <!-- è¯­éŸ³è¯†åˆ«ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                  <div id="voiceResultContainer" class="voice-result-container hidden">
                    <div class="voice-result-header">
                      <span>ğŸ¤ è¯­éŸ³è¯†åˆ«ä¸­...</span>
                    </div>
                    <div id="voiceResultText" class="voice-result-text"></div>
                    <div id="voiceVisualizerContainer" class="voice-visualizer-container"></div>
                  </div>
                  

                  
                  <div id="filePreviewContainer" class="file-preview-container hidden">
                    <div id="filePreviewContent" class="file-preview-content"></div>
                  </div>
                </div>
              </div>
              
              <div class="additional-info-box">
                  <p class="additional-info-text">
                  âš ï¸ <strong>æ¸©é¦¨æç¤ºï¼š</strong>æ™ºèƒ½å¯¼è¯Šä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç”Ÿçš„è¯Šæ–­ã€‚å¦‚æœ‰ç´§æ€¥æƒ…å†µï¼Œè¯·ç«‹å³å‰å¾€åŒ»é™¢å°±è¯Šã€‚
                </p>
              </div>
              
            </div>
          </div>
        </main>
      </div>
    </div>
    
    <script>
      // Dify API é…ç½®
      const DIFY_API_KEY = 'app-c6suQBrrp11wDJh6ItBugWlr';
      const DIFY_BASE_URL = 'http://192.168.1.102/v1';
      const DIFY_USER_ID = 'web_user_' + Date.now();
      
      // å®šä¹‰å…¨å±€ç”¨æˆ·IDï¼Œç”¨äºDify APIè°ƒç”¨
      const userId = DIFY_USER_ID;
      
      // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
      function setupAutoResizeTextarea() {
        const textarea = document.querySelector('.chat-input textarea');
        if (textarea) {
          // åˆå§‹åŒ–æ—¶è°ƒæ•´ä¸€æ¬¡é«˜åº¦
          textarea.style.height = 'auto';
          textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
          
          // è¾“å…¥æ—¶è‡ªåŠ¨è°ƒæ•´é«˜åº¦
          textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
          });
        }
      }
      
      // ä¾§è¾¹æ æŠ˜å åŠŸèƒ½
      function toggleSider() {
        const sider = document.querySelector('.app-sider');
        const trigger = document.querySelector('.trigger');
        
        if (sider.classList.contains('collapsed')) {
          sider.classList.remove('collapsed');
          trigger.textContent = 'æ”¶èµ·';
        } else {
          sider.classList.add('collapsed');
          trigger.textContent = 'å±•å¼€';
        }
      }
      
      // å‘é€æ¶ˆæ¯åŠŸèƒ½ - å·²åˆå¹¶ä¸ºç»Ÿä¸€çš„å®ç°
      
      // æ·»åŠ "æ­£åœ¨æ€è€ƒ"æ¶ˆæ¯
      function addThinkingMessage(messageId) {
        const chatMessages = document.getElementById('chatMessages');
        
        const messageDiv = document.createElement('div');
        messageDiv.id = messageId;
        messageDiv.className = 'message-item assistant thinking';
        
        messageDiv.innerHTML = `
          <div class="avatar-container">
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-sender">æ™ºèƒ½å¯¼è¯ŠåŠ©æ‰‹</div>
          </div>
          <div class="message-content">
            <div class="typing-indicator">æ­£åœ¨åˆ†ææ‚¨çš„ç—‡çŠ¶...</div>
          </div>
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // ç§»é™¤"æ­£åœ¨æ€è€ƒ"æ¶ˆæ¯
      function removeThinkingMessage(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (messageDiv) {
          messageDiv.remove();
        }
      }
      
      // æ˜¾ç¤ºæ€è€ƒçŠ¶æ€
      function showThinking() {
        console.log('æ˜¾ç¤ºæ€è€ƒçŠ¶æ€');
        const thinkingMessageId = 'thinking-message-' + Date.now();
        addThinkingMessage(thinkingMessageId);
        return thinkingMessageId;
      }
      
      // éšè—æ€è€ƒçŠ¶æ€
      function hideThinking() {
        console.log('éšè—æ€è€ƒçŠ¶æ€');
        const thinkingMessage = document.querySelector('.message-item.assistant.thinking');
        if (thinkingMessage) {
          thinkingMessage.remove();
        }
      }
      
      // å…¨å±€å˜é‡
      let currentFiles = []; // å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶
      let conversationId = ''; // ä¼šè¯IDï¼Œç”¨äºç»´æŒå¯¹è¯ä¸Šä¸‹æ–‡
      let voiceRecorder = null; // è¯­éŸ³å½•éŸ³å™¨å®ä¾‹
      
      // VoiceRecorder ç±» - é›†æˆsimple-voice-input.htmlçš„é«˜çº§è¯­éŸ³åŠŸèƒ½
      class VoiceRecorder {
        constructor() {
          this.voiceBtn = document.getElementById('voiceButton');
          this.voiceCallBtn = document.getElementById('voiceCallButton');
          this.statusDiv = document.getElementById('voiceResultContainer');
          this.resultText = document.getElementById('voiceResultText');
          this.isRecording = false;
          this.isVoiceCall = false; // è¯­éŸ³é€šè¯æ¨¡å¼æ ‡å¿—
          this.recognition = null;
          this.stream = null;
          this.mediaRecorder = null;
          this.audioChunks = [];
          this.audioContext = null;
          this.analyser = null;
          this.canvas = null;
          this.canvasCtx = null;
          this.animationId = null;
          this.startTime = null;
          this.durationInterval = null;
          this.silenceTimer = null;
          this.hideTimer = null; // ç”¨äºè·Ÿè¸ªè¯­éŸ³é¢„è§ˆå®¹å™¨çš„å»¶è¿Ÿéšè—å®šæ—¶å™¨
          this.maxRecordingTime = 60000; // æœ€å¤§å½•éŸ³æ—¶é—´60ç§’
          
          this.init();
        }
        
        init() {
          this.initSpeechRecognition();
          this.voiceBtn.addEventListener('click', () => this.toggleVoiceInput());
          this.voiceCallBtn.addEventListener('click', () => this.toggleVoiceCall());
        }
        
        initSpeechRecognition() {
          try {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
              console.warn('æµè§ˆå™¨ä¸æ”¯æŒWeb Speech API');
              return false;
            }
            
            this.recognition = new SpeechRecognition();
            this.recognition.lang = 'zh-CN';
            this.recognition.continuous = true;
            this.recognition.interimResults = true;
            
            // åœé¡¿æ£€æµ‹é…ç½®
            this.silenceTimer = null;
            this.silenceThreshold = 3000; // 3ç§’åœé¡¿é˜ˆå€¼
            this.lastResultTime = 0;
            this.currentTranscript = '';
            
            this.recognition.onresult = (event) => {
              let finalTranscript = '';
              let interimTranscript = '';
              
              for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                  finalTranscript += transcript;
                } else {
                  interimTranscript += transcript;
                }
              }
              
              const currentText = interimTranscript || finalTranscript;
              this.showVoiceResult(currentText, !finalTranscript);
              
              // æ›´æ–°æœ€åè¯†åˆ«æ—¶é—´
              this.lastResultTime = Date.now();
              this.currentTranscript = currentText;
              
              // æ¸…é™¤ä¹‹å‰çš„åœé¡¿è®¡æ—¶å™¨
              if (this.silenceTimer) {
                clearTimeout(this.silenceTimer);
              }
              
              if (finalTranscript) {
                console.log('è¯­éŸ³è¯†åˆ«æœ€ç»ˆç»“æœ:', finalTranscript);
                if (this.isVoiceCall) {
                  // è¯­éŸ³é€šè¯æ¨¡å¼ï¼šå‘é€æ¶ˆæ¯ä½†ä¸åœæ­¢å½•éŸ³
                  this.sendVoiceMessage(finalTranscript);
                } else {
                  // æ™®é€šè¯­éŸ³è¾“å…¥æ¨¡å¼ï¼šåœæ­¢å½•éŸ³å¹¶å‘é€
                  this.stopRecording();
                  this.sendVoiceMessage(finalTranscript);
                }
              } else if (currentText && this.isVoiceCall) {
                // åœ¨è¯­éŸ³é€šè¯æ¨¡å¼ä¸‹ï¼Œå¦‚æœæœ‰ä¸´æ—¶ç»“æœï¼Œè®¾ç½®åœé¡¿æ£€æµ‹
                this.silenceTimer = setTimeout(() => {
                  console.log('æ£€æµ‹åˆ°3ç§’åœé¡¿ï¼Œè‡ªåŠ¨å‘é€:', this.currentTranscript);
                  // å‘é€å½“å‰è¯†åˆ«ç»“æœä½†ä¸åœæ­¢å½•éŸ³
                  this.sendVoiceMessage(this.currentTranscript);
                }, this.silenceThreshold);
              }
            };
            
            this.recognition.onend = () => {
              console.log('è¯­éŸ³è¯†åˆ«ç»“æŸ');
              if (this.isRecording && this.isVoiceCall) {
                // è¯­éŸ³é€šè¯æ¨¡å¼ä¸‹ï¼Œè‡ªåŠ¨é‡å¯è¯†åˆ«
                console.log('è¯­éŸ³é€šè¯æ¨¡å¼ä¸‹è‡ªåŠ¨é‡å¯è¯†åˆ«');
                this.recognition.start();
              } else {
                this.stopRecording();
              }
            };
            
            this.recognition.onerror = (event) => {
              console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
              if (this.isRecording && this.isVoiceCall) {
                // è¯­éŸ³é€šè¯æ¨¡å¼ä¸‹ï¼Œå°è¯•é‡å¯è¯†åˆ«
                console.log('è¯­éŸ³é€šè¯æ¨¡å¼ä¸‹å°è¯•é‡å¯è¯†åˆ«');
                setTimeout(() => {
                  if (this.isRecording) {
                    this.recognition.start();
                  }
                }, 1000);
              } else {
                this.stopRecording();
                alert('è¯­éŸ³è¯†åˆ«å‡ºé”™: ' + event.error);
              }
            };
            
            return true;
          } catch (error) {
            console.error('åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
            return false;
          }
        }
        
        async toggleVoiceInput() {
          if (this.isRecording) {
            this.stopRecording();
          } else {
            // åˆ‡æ¢åŠŸèƒ½å‰ç¡®ä¿æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
            this.clearAllTimers();
            this.isVoiceCall = false;
            await this.startRecording();
          }
        }
        
        async toggleVoiceCall() {
          if (this.isRecording) {
            this.stopRecording();
          } else {
            // åˆ‡æ¢åŠŸèƒ½å‰ç¡®ä¿æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
            this.clearAllTimers();
            this.isVoiceCall = true;
            await this.startRecording();
          }
        }
        
        async startRecording() {
          try {
            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
              throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½');
            }
            
            this.updateStatus('ğŸ¤ æ­£åœ¨è·å–éº¦å…‹é£æƒé™...');
            
            // è·å–éº¦å…‹é£æƒé™
            this.stream = await navigator.mediaDevices.getUserMedia({ 
              audio: {
                echoCancellation: true,
                noiseSuppression: true,
                sampleRate: 44100
              }
            });
            
            // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.analyser = this.audioContext.createAnalyser();
            const source = this.audioContext.createMediaStreamSource(this.stream);
            source.connect(this.analyser);
            
            this.analyser.fftSize = 256;
            
            // åˆ›å»ºéŸ³é¢‘å¯è§†åŒ–å™¨
            this.createVisualizer();
            
            // å¼€å§‹å½•éŸ³
            this.mediaRecorder = new MediaRecorder(this.stream);
            this.audioChunks = [];
            
            this.mediaRecorder.ondataavailable = (event) => {
              this.audioChunks.push(event.data);
            };
            
            this.mediaRecorder.start(100);
            
            // å¼€å§‹è¯­éŸ³è¯†åˆ«
            this.recognition.start();
            
            // å¼€å§‹éŸ³é¢‘å¯è§†åŒ–
            this.startVisualization();
            
            this.isRecording = true;
            
            if (this.isVoiceCall) {
              // æ›´æ–°è¯­éŸ³é€šè¯æŒ‰é’®çŠ¶æ€
              this.voiceCallBtn.classList.add('recording');
              this.voiceCallBtn.textContent = 'â¹ï¸ç»“æŸé€šè¯';
              this.voiceCallBtn.title = 'ç»“æŸè¯­éŸ³é€šè¯';
              this.updateStatus('ğŸ“ è¯­éŸ³é€šè¯å·²å¼€å§‹ï¼Œæ­£åœ¨å½•éŸ³ä¸­...');
            } else {
              // æ›´æ–°è¯­éŸ³è¾“å…¥æŒ‰é’®çŠ¶æ€
              this.voiceBtn.classList.add('recording');
              this.voiceBtn.textContent = 'â¹ï¸åœæ­¢å½•éŸ³';
              this.voiceBtn.title = 'åœæ­¢å½•éŸ³';
              this.updateStatus('ğŸ¤ æ­£åœ¨å½•éŸ³ä¸­...');
            }
            
          } catch (error) {
            console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error);
            let errorMessage = 'å½•éŸ³å¯åŠ¨å¤±è´¥';
            
            if (error.name === 'NotAllowedError') {
              errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
            } else if (error.name === 'NotFoundError') {
              errorMessage = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡';
            } else if (error.name === 'NotReadableError') {
              errorMessage = 'éº¦å…‹é£è¢«å…¶ä»–åº”ç”¨å ç”¨';
            } else {
              errorMessage = 'å½•éŸ³å¯åŠ¨å¤±è´¥: ' + error.message;
            }
            
            this.updateStatus('âŒ ' + errorMessage);
            alert(errorMessage);
            
            // é‡ç½®çŠ¶æ€
            this.stopRecording();
          }
        }
        
        clearAllTimers() {
          // æ¸…é™¤æ‰€æœ‰ç›¸å…³å®šæ—¶å™¨
          if (this.silenceTimer) {
            clearTimeout(this.silenceTimer);
            this.silenceTimer = null;
          }
          if (this.hideTimer) {
            clearTimeout(this.hideTimer);
            this.hideTimer = null;
          }
          if (this.durationInterval) {
            clearInterval(this.durationInterval);
            this.durationInterval = null;
          }
        }
        
        stopRecording() {
          this.isRecording = false;
          this.isVoiceCall = false;
          
          // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
          this.clearAllTimers();
            
            // åœæ­¢éŸ³é¢‘å¯è§†åŒ–
            if (this.animationId) {
              cancelAnimationFrame(this.animationId);
              this.animationId = null;
            }
            
            if (this.recognition) {
              this.recognition.stop();
            }
            
            if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
              this.mediaRecorder.stop();
            }
            
            if (this.stream) {
              this.stream.getTracks().forEach(track => track.stop());
            }
            
            if (this.audioContext) {
              this.audioContext.close();
            }
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            this.voiceCallBtn.classList.remove('recording');
            this.voiceCallBtn.textContent = 'ğŸ“ è¯­éŸ³é€šè¯';
            this.voiceCallBtn.title = 'è¯­éŸ³é€šè¯';
            
            this.voiceBtn.classList.remove('recording');
            this.voiceBtn.textContent = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
            this.voiceBtn.title = 'è¯­éŸ³è¾“å…¥';
            
            this.hideVoiceResult();
            
            // é‡ç½®æ—¶é—´
            this.startTime = null;
          }
        
        // å‘é€è¯­éŸ³æ¶ˆæ¯
        sendVoiceMessage(text) {
          if (text.trim()) {
            console.log('å‘é€è¯­éŸ³æ¶ˆæ¯:', text);
            // å°†è¯†åˆ«ç»“æœå¡«å…¥è¾“å…¥æ¡†å¹¶å‘é€
            document.getElementById('messageInput').value = text;
            sendMessage();
            // æ¸…ç©ºå½“å‰è½¬å½•å†…å®¹ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡è¯†åˆ«
            this.currentTranscript = '';
            if (this.isVoiceCall) {
              this.showVoiceResult('', true); // æ¸…ç©ºæ˜¾ç¤ºä½†ä¿æŒè¯­éŸ³è¯†åˆ«ç•Œé¢
            }
          }
        }
        
        updateStatus(message) {
          if (this.statusDiv) {
            this.statusDiv.classList.remove('hidden');
            const header = this.statusDiv.querySelector('.voice-result-header span');
            if (header) {
              header.textContent = message;
            }
          }
        }
        
        showVoiceResult(text, isInterim) {
          if (this.resultText) {
            this.resultText.textContent = text;
            this.resultText.classList.toggle('interim', isInterim);
          }
        }
        
        hideVoiceResult() {
          // æ¸…é™¤ä¹‹å‰çš„å»¶è¿Ÿéšè—å®šæ—¶å™¨ï¼Œé¿å…å†²çª
          if (this.hideTimer) {
            clearTimeout(this.hideTimer);
          }
          
          this.hideTimer = setTimeout(() => {
            if (this.statusDiv && !this.isRecording) {
              this.statusDiv.classList.add('hidden');
            }
            this.hideTimer = null;
          }, 1000);
        }
        
        createVisualizer() {
          // ç¦ç”¨éŸ³é¢‘å¯è§†åŒ–å™¨åˆ›å»º
          //if (!this.statusDiv) return;
          
          // åˆ›å»ºéŸ³é¢‘å¯è§†åŒ–å™¨å®¹å™¨
          //const visualizerContainer = document.createElement('div');
          //visualizerContainer.className = 'audio-visualizer';
          
          // åˆ›å»ºcanvaså…ƒç´ 
          //this.canvas = document.createElement('canvas');
          //this.canvas.className = 'visualizer-canvas';
          //this.canvas.width = this.statusDiv.offsetWidth - 24; // å‡å»padding
          //this.canvas.height = 60;
          
          //visualizerContainer.appendChild(this.canvas);
          //this.statusDiv.insertBefore(visualizerContainer, this.resultText);
          
          //this.canvasCtx = this.canvas.getContext('2d');
        }
        
        startVisualization() {
          if (!this.canvasCtx || !this.analyser) return;
          
          const bufferLength = this.analyser.frequencyBinCount;
          const dataArray = new Uint8Array(bufferLength);
          
          const draw = () => {
            if (!this.isRecording) return;
            
            this.animationId = requestAnimationFrame(draw);
            
            this.analyser.getByteFrequencyData(dataArray);
            
            this.canvasCtx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            
            const barWidth = (this.canvas.width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;
            
            for (let i = 0; i < bufferLength; i++) {
              barHeight = (dataArray[i] / 255) * this.canvas.height;
              
              const gradient = this.canvasCtx.createLinearGradient(0, this.canvas.height - barHeight, 0, this.canvas.height);
              gradient.addColorStop(0, 'rgba(0, 137, 123, 0.8)');
              gradient.addColorStop(1, 'rgba(38, 166, 154, 0.4)');
              
              this.canvasCtx.fillStyle = gradient;
              this.canvasCtx.fillRect(x, this.canvas.height - barHeight, barWidth, barHeight);
              
              x += barWidth + 1;
            }
          };
          
          draw();
        }
      }
      
      // DOMContentLoadedäº‹ä»¶ç›‘å¬å™¨ç¡®ä¿DOMå…ƒç´ åŠ è½½å®Œæ¯•åå†ç»‘å®šäº‹ä»¶
      document.addEventListener('DOMContentLoaded', function() {
          console.log('======= DOMContentLoadedäº‹ä»¶è§¦å‘ =======');
          
          // è®¾ç½®è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
          setupAutoResizeTextarea();
          
          // åˆå§‹åŒ–è¯­éŸ³å½•éŸ³å™¨
          voiceRecorder = new VoiceRecorder();
          
          // è·å–DOMå…ƒç´ 
          console.log('æŸ¥æ‰¾DOMå…ƒç´ ...');
          const sendButton = document.getElementById('sendButton');
          const messageInput = document.getElementById('messageInput');
          
          console.log('å…ƒç´ æŸ¥æ‰¾ç»“æœ:', {
              sendButton: sendButton ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°',
              messageInput: messageInput ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°',
              voiceButton: voiceButton ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'
          });
          
          console.log('======= äº‹ä»¶ç»‘å®šå®Œæˆ =======');
        });
      
      // æš´éœ²æµ‹è¯•å‡½æ•°åˆ°å…¨å±€ï¼Œæ–¹ä¾¿ç›´æ¥è°ƒç”¨
        window.testChat = function() {
            console.log('======= å…¨å±€æµ‹è¯•å‡½æ•°testChatè¢«è°ƒç”¨ =======');
            console.log('å¦‚æœæ‚¨åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¯·ç¡®ä¿ç‚¹å‡»é¡µé¢ä¸Šçš„ğŸ” æµ‹è¯•æŒ‰é’®æˆ–å‘é€æŒ‰é’®æ¥å®é™…è§¦å‘APIè°ƒç”¨ã€‚');
            
            try {
                const messageInput = document.getElementById('messageInput');
                if (messageInput) {
                    messageInput.value = 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯';
                    console.log('âœ… æ¶ˆæ¯è¾“å…¥æ¡†å·²è®¾ç½®æµ‹è¯•æ–‡æœ¬');
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°æ¶ˆæ¯è¾“å…¥æ¡†ï¼Œä½†ä»å°†å°è¯•å‘é€');
                }
                
                console.log('âœ… å¼€å§‹è°ƒç”¨sendMessageå‡½æ•°...');
                sendMessage();
            } catch (error) {
                console.error('âŒ æµ‹è¯•å‡½æ•°æ‰§è¡Œå¤±è´¥:', error);
                alert('æµ‹è¯•æ‰§è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯');
            }
        };
      
      // å¤„ç†æŒ‰é”®äº‹ä»¶
      function handleKeyPress(event) {
        console.log('handleKeyPresså‡½æ•°è¢«è°ƒç”¨ï¼ŒæŒ‰é”®:', event.key);
        if (event.key === 'Enter' && !event.shiftKey) {
          console.log('æ£€æµ‹åˆ°Enteré”®ï¼ˆæ— Shiftï¼‰ï¼Œè°ƒç”¨sendMessage()');
          event.preventDefault();
          sendMessage();
        }
      }
      
      // å¤„ç†æ–‡ä»¶ä¸Šä¼  - å…¼å®¹Edgeæµè§ˆå™¨ç‰ˆæœ¬
      function handleFileUpload(event) {
        // ç¡®ä¿eventå¯¹è±¡å­˜åœ¨ä¸”åŒ…å«targetå±æ€§
        if (!event || !event.target) {
          console.error('äº‹ä»¶å¯¹è±¡æ— æ•ˆ');
          return;
        }
        
        const files = event.target.files;
        if (!files || files.length === 0) return;
        
        // æ¸…ç©ºå½“å‰æ–‡ä»¶åˆ—è¡¨å’Œé¢„è§ˆ
        currentFiles = [];
        const previewContainer = document.getElementById('filePreviewContainer');
        const previewContent = document.getElementById('filePreviewContent');
        
        // ç¡®ä¿DOMå…ƒç´ å­˜åœ¨
        if (!previewContainer || !previewContent) {
          console.error('é¢„è§ˆå®¹å™¨å…ƒç´ æœªæ‰¾åˆ°');
          return;
        }
        
        // æ¸…ç©ºé¢„è§ˆå†…å®¹
        previewContent.innerHTML = '';
        
        // ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºé¢„è§ˆ
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          currentFiles.push(file);
          
          // æ£€æŸ¥æ–‡ä»¶å¤§å°
          const maxSizeMB = 15; // æ ¹æ®DifyAPIè¦æ±‚ï¼Œæœ€å¤§15MB
          if (file.size > maxSizeMB * 1024 * 1024) {
            // ä½¿ç”¨æ ‡å‡†çš„alertï¼Œç¡®ä¿Edgeå…¼å®¹
            window.alert(`${file.name} æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶(${maxSizeMB}MB)`);
            continue;
          }
          
          // åˆ›å»ºé¢„è§ˆå…ƒç´ 
          const fileItem = document.createElement('div');
          fileItem.className = 'file-preview-item';
          
          // æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡
          let icon = 'ğŸ“„';
          if (file.type && file.type.startsWith('image/')) {
            icon = 'ğŸ–¼ï¸';
            // å¯¹äºå›¾ç‰‡ï¼Œåˆ›å»ºå¸¦ç¼©ç•¥å›¾çš„é¢„è§ˆ
            // ä½¿ç”¨Edgeå…¼å®¹çš„æ–¹å¼åˆ›å»ºé¢„è§ˆ
            try {
              // æ£€æŸ¥FileReader APIæ˜¯å¦å¯ç”¨
              if (window.FileReader) {
                const reader = new FileReader();
                
                // ä½¿ç”¨å‡½æ•°ä½œç”¨åŸŸä¿å­˜å½“å‰ç´¢å¼•å’Œæ–‡ä»¶åï¼Œé¿å…é—­åŒ…é—®é¢˜
                reader.onload = (function(fileIndex, fileName) {
                  return function(e) {
                    if (e && e.target && e.target.result) {
                      const imgSrc = e.target.result;
                      // ä½¿ç”¨å­—ç¬¦ä¸²è¿æ¥è€Œéå¤šè¡Œå­—ç¬¦ä¸²ï¼Œç¡®ä¿JavaScriptè¯­æ³•æ­£ç¡®
                      fileItem.innerHTML = '<img src="' + imgSrc + '" alt="' + fileName + '" class="file-preview-thumbnail">' +
                                          '<div class="file-preview-info">' +
                                          '  <span class="file-preview-name">' + fileName + '</span>' +
                                          '  <span class="file-preview-size">' + ((file.size / 1024).toFixed(1)) + 'KB</span>' +
                                          '  <span class="file-preview-remove" data-index="' + fileIndex + '">&times;</span>' +
                                          '</div>';
                      
                      // ä¸ºç§»é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…ä½¿ç”¨å†…è”onclick
                      const removeBtn = fileItem.querySelector('.file-preview-remove');
                      if (removeBtn) {
                        removeBtn.onclick = function() {
                          removeFile(parseInt(this.getAttribute('data-index')));
                        };
                      }
                    }
                  };
                })(i, file.name);
                
                // ä½¿ç”¨readAsDataURLæ–¹æ³•è¯»å–æ–‡ä»¶
                reader.readAsDataURL(file);
              } else {
                // å¦‚æœFileReaderä¸å¯ç”¨ï¼Œæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                // ä½¿ç”¨å­—ç¬¦ä¸²è¿æ¥è€Œéå¤šè¡Œå­—ç¬¦ä¸²ï¼Œç¡®ä¿JavaScriptè¯­æ³•æ­£ç¡®
                fileItem.innerHTML = '<div class="file-preview-info">' +
                                    '  <span class="file-preview-icon">' + icon + '</span>' +
                                    '  <span class="file-preview-name">' + file.name + '</span>' +
                                    '  <span class="file-preview-size">' + ((file.size / 1024).toFixed(1)) + 'KB</span>' +
                                    '  <span class="file-preview-remove" data-index="' + i + '">&times;</span>' +
                                    '</div>';
                
                // ä¸ºç§»é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                const removeBtn = fileItem.querySelector('.file-preview-remove');
                if (removeBtn) {
                  removeBtn.onclick = function() {
                    removeFile(parseInt(this.getAttribute('data-index')));
                  };
                }
              }
            } catch (error) {
                console.error('å¤„ç†å›¾ç‰‡é¢„è§ˆæ—¶å‡ºé”™:', error);
                // å‡ºé”™æ—¶æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                // ä½¿ç”¨å­—ç¬¦ä¸²è¿æ¥è€Œéå¤šè¡Œå­—ç¬¦ä¸²ï¼Œç¡®ä¿JavaScriptè¯­æ³•æ­£ç¡®
                fileItem.innerHTML = '<div class="file-preview-info">' +
                                    '  <span class="file-preview-icon">' + icon + '</span>' +
                                    '  <span class="file-preview-name">' + file.name + '</span>' +
                                    '  <span class="file-preview-size">' + ((file.size / 1024).toFixed(1)) + 'KB</span>' +
                                    '  <span class="file-preview-remove" data-index="' + i + '">&times;</span>' +
                                    '</div>';
              
              // ä¸ºç§»é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
              const removeBtn = fileItem.querySelector('.file-preview-remove');
              if (removeBtn) {
                removeBtn.onclick = function() {
                  removeFile(parseInt(this.getAttribute('data-index')));
                };
              }
            }
          } else {
              if (file.type && file.type.startsWith('audio/')) {
                icon = 'ğŸ”Š';
              }
              // ä½¿ç”¨å­—ç¬¦ä¸²è¿æ¥è€Œéå¤šè¡Œå­—ç¬¦ä¸²ï¼Œç¡®ä¿JavaScriptè¯­æ³•æ­£ç¡®
              fileItem.innerHTML = '<div class="file-preview-info">' +
                                  '  <span class="file-preview-icon">' + icon + '</span>' +
                                  '  <span class="file-preview-name">' + file.name + '</span>' +
                                  '  <span class="file-preview-size">' + ((file.size / 1024).toFixed(1)) + 'KB</span>' +
                                  '  <span class="file-preview-remove" data-index="' + i + '">&times;</span>' +
                                  '</div>';
            
            // ä¸ºç§»é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const removeBtn = fileItem.querySelector('.file-preview-remove');
            if (removeBtn) {
              removeBtn.onclick = function() {
                removeFile(parseInt(this.getAttribute('data-index')));
              };
            }
          }
          
          // æ·»åŠ æ–‡ä»¶é¡¹åˆ°é¢„è§ˆå†…å®¹
          previewContent.appendChild(fileItem);
        }
        
        // æ˜¾ç¤ºé¢„è§ˆå®¹å™¨
        previewContainer.style.display = currentFiles.length > 0 ? 'block' : 'none';
        
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
        try {
          event.target.value = '';
          // Edgeæµè§ˆå™¨ä¸­å¯èƒ½éœ€è¦é¢å¤–å¤„ç†
          if (event.target.value) {
            event.target.type = '';
            event.target.type = 'file';
          }
        } catch (error) {
          console.error('é‡ç½®æ–‡ä»¶è¾“å…¥æ—¶å‡ºé”™:', error);
        }
      }
      
      // ç§»é™¤æ–‡ä»¶ - å…¼å®¹Edgeæµè§ˆå™¨ç‰ˆæœ¬
      function removeFile(index) {
        // å‚æ•°éªŒè¯
        if (typeof index !== 'number' || isNaN(index) || index < 0) {
          console.error('æ— æ•ˆçš„æ–‡ä»¶ç´¢å¼•:', index);
          return;
        }
        
        try {
          // ç¡®ä¿currentFilesæ•°ç»„å­˜åœ¨ä¸”ç´¢å¼•æœ‰æ•ˆ
          if (!Array.isArray(currentFiles) || index >= currentFiles.length) {
            console.error('æ–‡ä»¶ç´¢å¼•è¶…å‡ºèŒƒå›´');
            return;
          }
          
          // ä»æ•°ç»„ä¸­ç§»é™¤æ–‡ä»¶
          currentFiles.splice(index, 1);
          
          // è·å–DOMå…ƒç´ å¹¶è¿›è¡Œå­˜åœ¨æ€§æ£€æŸ¥
          const previewContent = document.getElementById('filePreviewContent');
          const previewContainer = document.getElementById('filePreviewContainer');
          
          if (!previewContent || !previewContainer) {
            console.error('é¢„è§ˆå®¹å™¨å…ƒç´ æœªæ‰¾åˆ°');
            return;
          }
          
          // ç¡®ä¿å­å…ƒç´ å­˜åœ¨ä¸”ç´¢å¼•æœ‰æ•ˆ
          if (previewContent.children && previewContent.children.length > index) {
            // ä½¿ç”¨try-catchå¤„ç†å¯èƒ½çš„DOMæ“ä½œé”™è¯¯
            try {
              previewContent.removeChild(previewContent.children[index]);
            } catch (domError) {
              console.error('ç§»é™¤DOMå…ƒç´ æ—¶å‡ºé”™:', domError);
              // å›é€€æ–¹æ¡ˆï¼šåˆ·æ–°æ•´ä¸ªé¢„è§ˆå†…å®¹
              refreshFilePreview();
            }
          }
          
          // æ›´æ–°é¢„è§ˆå®¹å™¨çš„æ˜¾ç¤ºçŠ¶æ€
          previewContainer.style.display = currentFiles.length > 0 ? 'block' : 'none';
        } catch (error) {
          console.error('ç§»é™¤æ–‡ä»¶æ—¶å‡ºé”™:', error);
          // å‡ºé”™æ—¶åˆ·æ–°æ•´ä¸ªé¢„è§ˆå†…å®¹ä½œä¸ºå›é€€æ–¹æ¡ˆ
          refreshFilePreview();
        }
      }
      
      // åˆ·æ–°æ–‡ä»¶é¢„è§ˆçš„è¾…åŠ©å‡½æ•° - ç”¨äºé”™è¯¯æ¢å¤
      function refreshFilePreview() {
        try {
          const previewContent = document.getElementById('filePreviewContent');
          const previewContainer = document.getElementById('filePreviewContainer');
          
          if (!previewContent || !previewContainer) {
            console.error('é¢„è§ˆå®¹å™¨å…ƒç´ æœªæ‰¾åˆ°');
            return;
          }
          
          // æ¸…ç©ºå½“å‰é¢„è§ˆå†…å®¹
          previewContent.innerHTML = '';
          
          // é‡æ–°åˆ›å»ºæ‰€æœ‰å‰©ä½™æ–‡ä»¶çš„é¢„è§ˆ
          for (let i = 0; i < currentFiles.length; i++) {
            const file = currentFiles[i];
            const fileItem = document.createElement('div');
            fileItem.className = 'file-preview-item';
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡
            let icon = 'ğŸ“„';
            if (file.type && file.type.startsWith('image/')) {
              icon = 'ğŸ–¼ï¸';
            } else if (file.type && file.type.startsWith('audio/')) {
              icon = 'ğŸ”Š';
            }
            
            // åˆ›å»ºåŸºæœ¬ä¿¡æ¯æ˜¾ç¤º
            // ä½¿ç”¨å­—ç¬¦ä¸²è¿æ¥è€Œéå¤šè¡Œå­—ç¬¦ä¸²ï¼Œç¡®ä¿JavaScriptè¯­æ³•æ­£ç¡®
              fileItem.innerHTML = '<div class="file-preview-info">' +
                                  '  <span class="file-preview-icon">' + icon + '</span>' +
                                  '  <span class="file-preview-name">' + file.name + '</span>' +
                                  '  <span class="file-preview-size">' + ((file.size / 1024).toFixed(1)) + 'KB</span>' +
                                  '  <span class="file-preview-remove" data-index="' + i + '">&times;</span>' +
                                  '</div>';
            
            // ä¸ºç§»é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const removeBtn = fileItem.querySelector('.file-preview-remove');
            if (removeBtn) {
              removeBtn.onclick = function() {
                removeFile(parseInt(this.getAttribute('data-index')));
              };
            }
            
            previewContent.appendChild(fileItem);
          }
          
          // æ›´æ–°é¢„è§ˆå®¹å™¨çš„æ˜¾ç¤ºçŠ¶æ€
          previewContainer.style.display = currentFiles.length > 0 ? 'block' : 'none';
        } catch (error) {
          console.error('åˆ·æ–°æ–‡ä»¶é¢„è§ˆæ—¶å‡ºé”™:', error);
        }
      }
      
      // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
      function addMessageToChat(role, sender, content, files = []) {
        const chatMessages = document.getElementById('chatMessages');
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-item ${role}`;
        
        const avatarIcon = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
        
        // å¤„ç†åŒ…å«å›¾ç‰‡çš„å†…å®¹
        const processedContent = processContentWithImages(content);
        
        // æ„å»ºæ¶ˆæ¯HTML - å°†å‘é€è€…ä¿¡æ¯ç§»åˆ°å¤´åƒä¸‹æ–¹
        // å¯¹åŠ©æ‰‹æ¶ˆæ¯è¿›è¡ŒMarkdownè½¬çº¯æ–‡æœ¬å¤„ç†
        let finalContent = processedContent;
        if (role === 'assistant') {
          finalContent = convertMarkdownToPlainText(processedContent);
          // è½¬æ¢åå†å¤„ç†å›¾ç‰‡æ˜¾ç¤º
          finalContent = processContentWithImages(finalContent);
        }
        
        let messageHTML = `
          <div class="avatar-container">
            <div class="message-avatar">${avatarIcon}</div>
            <div class="message-sender">${sender}</div>
          </div>
          <div class="message-content">
            ${finalContent}
        `;
        
        // æ·»åŠ æ–‡ä»¶é¢„è§ˆï¼ˆå¦‚æœæœ‰ï¼‰
        if (files && files.length > 0) {
          messageHTML += '<div class="message-files">';
          files.forEach(file => {
            let fileIcon = 'ğŸ“„';
            let fileType = 'æ–‡ä»¶';
            
            if (file.type.startsWith('image/')) {
              fileIcon = 'ğŸ–¼ï¸';
              fileType = 'å›¾ç‰‡';
            } else if (file.type.startsWith('audio/')) {
              fileIcon = 'ğŸ”Š';
              fileType = 'éŸ³é¢‘';
            }
            
            messageHTML += `
              <div class="message-file-item">
                <span>${fileIcon}</span>
                <span>${file.name}</span>
                <span class="file-size">${(file.size / 1024).toFixed(1)}KB</span>
              </div>
            `;
          });
          messageHTML += '</div>';
        }
        
        messageHTML += '</div>';
        messageDiv.innerHTML = messageHTML;
        
        chatMessages.appendChild(messageDiv);
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // å‘é€æ¶ˆæ¯
      async function sendMessage() {
        console.log('======= å‘é€æ¶ˆæ¯å¼€å§‹ =======');
        
        try {
          const messageInput = document.getElementById('messageInput');
          const messageText = messageInput.value.trim();
          
          console.log('æ¶ˆæ¯æ–‡æœ¬:', messageText);
          console.log('å½“å‰æ–‡ä»¶æ•°é‡:', currentFiles.length);
          
          // æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯å†…å®¹æˆ–æ–‡ä»¶
          if (messageText === '' && currentFiles.length === 0) {
            console.log('æ²¡æœ‰æ¶ˆæ¯å†…å®¹æˆ–æ–‡ä»¶ï¼Œé€€å‡ºå‡½æ•°');
            return;
          }
          
          // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
          console.log('æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢');
          addMessageToChat('user', 'æˆ‘', messageText, currentFiles);
          
          // æ¸…ç©ºè¾“å…¥æ¡†å’Œæ–‡ä»¶åˆ—è¡¨
          messageInput.value = '';
          const tempFiles = [...currentFiles];
          currentFiles = [];
          const previewContainer = document.getElementById('filePreviewContainer');
          if (previewContainer) {
            previewContainer.style.display = 'none';
          }
          const previewContent = document.getElementById('filePreviewContent');
          if (previewContent) {
            previewContent.innerHTML = '';
          }
          
          // æ˜¾ç¤ºæ€è€ƒçŠ¶æ€
          console.log('æ˜¾ç¤ºæ€è€ƒçŠ¶æ€');
          showThinking();
          
          // è°ƒç”¨åç«¯APIå¤„ç†æ¶ˆæ¯å’Œæ–‡ä»¶
          const response = await callDifyAPI(messageText, tempFiles, conversationId);
          
          console.log('APIå“åº”æ•°æ®:', JSON.stringify(response));
          
          // éšè—æ€è€ƒçŠ¶æ€
          console.log('éšè—æ€è€ƒçŠ¶æ€');
          hideThinking();
          
          // æ›´æ–°ä¼šè¯ID
          if (response.conversation_id) {
            console.log('æ›´æ–°ä¼šè¯ID:', response.conversation_id);
            conversationId = response.conversation_id;
          }
          
          // æ·»åŠ AIå›å¤åˆ°èŠå¤©ç•Œé¢
          // ä¿®å¤ï¼šä»response.responseä¸­æå–å®é™…çš„Difyå“åº”å†…å®¹
          let replyContent;
          if (response.success && response.response) {
            // æˆåŠŸåç«¯è¿”å›çš„ç»“æ„ï¼š{success: true, response: {...}}
            const actualResponse = response.response;
            replyContent = actualResponse?.answer || 
                          actualResponse?.content?.text || 
                          actualResponse?.text ||
                          'æ”¶åˆ°å“åº”ï¼Œä½†æ²¡æœ‰æ¶ˆæ¯å†…å®¹';
            console.log('ä»response.responseä¸­æå–å›å¤:', replyContent);
          } else if (response.answer || response.content) {
            // å¦‚æœç›´æ¥è¿”å›äº†Difyå“åº”æ ¼å¼
            replyContent = response.answer || response.content?.text || 'æ”¶åˆ°å“åº”ï¼Œä½†æ²¡æœ‰æ¶ˆæ¯å†…å®¹';
            console.log('ä»ç›´æ¥å“åº”ä¸­æå–å›å¤:', replyContent);
          } else {
            // å…¶ä»–æƒ…å†µ
            replyContent = 'æ”¶åˆ°å“åº”ï¼Œä½†æ²¡æœ‰æ¶ˆæ¯å†…å®¹';
            console.log('ä½¿ç”¨é»˜è®¤å›å¤ï¼Œå“åº”ç»“æ„:', JSON.stringify(response));
          }
          
          console.log('æœ€ç»ˆå›å¤å†…å®¹:', replyContent);
          addMessageToChat('assistant', 'æ™ºèƒ½å¯¼è¯ŠåŠ©æ‰‹', replyContent);
          
        } catch (error) {
          console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
          console.error('é”™è¯¯ç±»å‹:', error.name);
          console.error('é”™è¯¯ä¿¡æ¯:', error.message);
          hideThinking();
          addMessageToChat('assistant', 'æ™ºèƒ½å¯¼è¯ŠåŠ©æ‰‹', 'æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶æ— æ³•æä¾›æœåŠ¡ï¼Œè¯·ç¨åå†è¯•ã€‚é”™è¯¯è¯¦æƒ…: ' + error.message);
        } finally {
          console.log('======= å‘é€æ¶ˆæ¯ç»“æŸ =======');
        }
        }
        
      // ä¸Šä¼ æ–‡ä»¶åˆ° Dify API
      async function uploadFileToDify(file) {
        console.log('ä¸Šä¼ æ–‡ä»¶åˆ°Dify:', file.name);
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('user', userId);
        
        const response = await fetch(`${DIFY_BASE_URL}/files/upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${DIFY_API_KEY}`
          },
          body: formData
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', errorText);
          throw new Error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', result);
        return result;
      }
      
      // å¼€å§‹æ–°å¯¹è¯
      function startNewChat() {
        conversationId = '';
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
          chatMessages.innerHTML = `
            <div class="welcome-message">
              <div class="welcome-avatar">âš•ï¸</div>
              <div class="welcome-text">
                <h4>æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å¯¼è¯Šç³»ç»Ÿ</h4>
                <p>è¯·æè¿°æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ‘å°†ä¸ºæ‚¨æ¨èåˆé€‚çš„ç§‘å®¤ã€‚</p>
              </div>
            </div>
          `;
        }
        console.log('âœ… å·²å¼€å§‹æ–°å¯¹è¯');
      }
        
        // è°ƒç”¨Dify APIï¼Œæ”¯æŒæ–‡ä»¶ä¸Šä¼  - ä½¿ç”¨åç«¯ä»£ç†
      async function callDifyAPI(messageText, files = currentFiles, convId = conversationId) {
        console.log('======= è°ƒç”¨ Dify API å¼€å§‹ =======');
        console.log('æ¶ˆæ¯:', messageText);
        console.log('æ–‡ä»¶æ•°é‡:', files.length);
        console.log('ä¼šè¯ID:', convId);
        
        try {
          // åˆ›å»º FormData å¯¹è±¡
          const formData = new FormData();
          
          // æ·»åŠ æ–‡æœ¬æ¶ˆæ¯
          formData.append('query', messageText || 'è¯·æè¿°æ‚¨çš„ç—‡çŠ¶');
          
          // å¦‚æœæœ‰ä¼šè¯IDï¼Œåˆ™æ·»åŠ 
          if (convId) {
            formData.append('conversation_id', convId);
          }
          
          // æ·»åŠ ç”¨æˆ·æ ‡è¯†
          formData.append('user', userId);
          
          // æ·»åŠ å“åº”æ¨¡å¼
          formData.append('response_mode', 'blocking');
          
          // æ·»åŠ è¾“å…¥å‚æ•°
          formData.append('inputs', JSON.stringify({}));
          
          // å¦‚æœæœ‰æ–‡ä»¶ï¼Œåˆ™é€ä¸ªæ·»åŠ åˆ° FormData ä¸­
          if (files && files.length > 0) {
            for (let i = 0; i < files.length; i++) {
              formData.append('files', files[i]);
            }
          }
          
          console.log('FormData å‡†å¤‡å®Œæˆ');
          
          // å‘é€è¯·æ±‚åˆ°åç«¯ - ä½¿ç”¨ç»å¯¹è·¯å¾„æ”¯æŒè·¨åŸŸ
          const response = await fetch('http://localhost:7000/api/dify/chat', {
            method: 'POST',
            body: formData
          });
          
          console.log('åç«¯å“åº”çŠ¶æ€:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('åç«¯å“åº”é”™è¯¯:', errorText);
            throw new Error(`åç«¯è¯·æ±‚å¤±è´¥: ${response.status} ${errorText}`);
          }
          
          const data = await response.json();
          console.log('åç«¯å“åº”æ•°æ®:', JSON.stringify(data));
          
          console.log('======= è°ƒç”¨ Dify API ç»“æŸ =======');
          return data;
        } catch (error) {
          console.error('è°ƒç”¨ Dify API å¤±è´¥:', error);
          throw error;
        }
      }
      
      // å¤„ç†å†…å®¹ä¸­çš„å›¾ç‰‡URLï¼Œå°†å…¶è½¬æ¢ä¸ºå¯æ˜¾ç¤ºçš„å›¾ç‰‡æ ‡ç­¾ - å…¼å®¹Edgeæµè§ˆå™¨ç‰ˆæœ¬
      function processContentWithImages(content) {
        try {
          // å‚æ•°éªŒè¯
          if (typeof content !== 'string') {
            console.error('å†…å®¹å‚æ•°å¿…é¡»æ˜¯å­—ç¬¦ä¸²ç±»å‹');
            return content || '';
          }
          
          // æ£€æŸ¥å†…å®¹æ˜¯å¦å·²ç»åŒ…å«HTML imgæ ‡ç­¾ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›
          if (content.indexOf('<img ') !== -1 || content.indexOf('<img>') !== -1) {
            return content;
          }
          
          // ä½¿ç”¨å…¼å®¹Edgeçš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…Markdownæ ¼å¼çš„å›¾ç‰‡
          // ç®€åŒ–æ­£åˆ™è¡¨è¾¾å¼ä»¥ç¡®ä¿åœ¨Edgeä¸­å¯é å·¥ä½œ
          const markdownImageRegex = /!\[([^\]]*)\]\(\s*([^)]+)\s*\)/g;
          
          // æ›¿æ¢Markdownå›¾ç‰‡ä¸ºHTML imgæ ‡ç­¾
          // ä½¿ç”¨æ›´å…¼å®¹çš„å­—ç¬¦ä¸²å¤„ç†æ–¹å¼
          let processedContent = content;
          let match;
          const markdownMatches = [];
          
          // å…ˆæ”¶é›†æ‰€æœ‰åŒ¹é…é¡¹ï¼Œé¿å…åœ¨è¿­ä»£è¿‡ç¨‹ä¸­ä¿®æ”¹å­—ç¬¦ä¸²
          while ((match = markdownImageRegex.exec(content)) !== null) {
            markdownMatches.push({ match: match[0], alt: match[1], url: match[2] });
          }
          
          // æ›¿æ¢æ‰€æœ‰Markdownå›¾ç‰‡ä¸ºHTML imgæ ‡ç­¾
          for (let i = 0; i < markdownMatches.length; i++) {
            const { match, alt, url } = markdownMatches[i];
            // æ¸…ç†URLä¸­çš„ç©ºç™½å­—ç¬¦å’Œåå¼•å·ï¼Œç¡®ä¿Edgeæµè§ˆå™¨å…¼å®¹æ€§
            const cleanUrl = String(url).trim().replace(/`/g, '');
            // ä½¿ç”¨å­—ç¬¦ä¸²è¿æ¥è€Œéæ¨¡æ¿å­—ç¬¦ä¸²ï¼Œæé«˜å…¼å®¹æ€§
            const imgTag = '<img src="' + cleanUrl + '" alt="' + (alt || 'å›¾ç‰‡') + '" class="chat-image" />';
            processedContent = processedContent.replace(match, imgTag);
          }
          
          // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å•ç‹¬çš„å›¾ç‰‡URL
          const imageUrlRegex = /(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|bmp|svg))/gi;
          const urlMatches = [];
          
          // æ”¶é›†æ‰€æœ‰åŒ¹é…çš„URL
          while ((match = imageUrlRegex.exec(processedContent)) !== null) {
            urlMatches.push(match[0]);
          }
          
          // æ›¿æ¢å•ç‹¬çš„å›¾ç‰‡URLä¸ºHTML imgæ ‡ç­¾ï¼Œä½†é¿å…é‡å¤æ›¿æ¢
          for (let i = 0; i < urlMatches.length; i++) {
            let url = urlMatches[i];
            // æ¸…ç†URLä¸­çš„åå¼•å·ï¼Œç¡®ä¿Edgeæµè§ˆå™¨å…¼å®¹æ€§
            url = url.replace(/`/g, '');
            // ä½¿ç”¨indexOfè¿›è¡Œç®€å•æ£€æŸ¥ï¼Œé¿å…å¤æ‚çš„å­—ç¬¦ä¸²æ“ä½œ
            if (processedContent.indexOf('<img src="' + url + '"') === -1) {
              const imgTag = '<img src="' + url + '" alt="å›¾ç‰‡" class="chat-image" />';
              processedContent = processedContent.replace(url, imgTag);
            }
          }
          
          return processedContent;
        } catch (error) {
          console.error('å¤„ç†å›¾ç‰‡å†…å®¹æ—¶å‡ºé”™:', error);
          // å‡ºé”™æ—¶è¿”å›åŸå§‹å†…å®¹ï¼Œç¡®ä¿åŠŸèƒ½ä¸ä¼šå®Œå…¨ä¸­æ–­
          return content || '';
        }
      }
      
      // Markdownè½¬çº¯æ–‡æœ¬è½¬æ¢å‡½æ•° - æŒ‰ç…§Difyæ ¼å¼è½¬æ¢æœºåˆ¶ï¼Œä¿ç•™åŸºæœ¬æ ¼å¼
      function convertMarkdownToPlainText(markdownContent) {
        if (!markdownContent) return '';
        
        let plainText = markdownContent;
        
        // 1. ç§»é™¤å›¾ç‰‡é“¾æ¥ ![alt](url)
        plainText = plainText.replace(/!\[.*?\]\(.*?\)/g, '');
        
        // 2. ç§»é™¤è¶…é“¾æ¥ä½†ä¿ç•™æ–‡æœ¬ [text](url) -> text
        plainText = plainText.replace(/\[(.*?)\]\((.*?)\)/g, '$1');
        
        // 3. ä¿ç•™ç²—ä½“æ ‡è®°ï¼Œä½†è½¬æ¢ä¸ºæ›´ç®€æ´çš„å½¢å¼ **text** -> text (ä¿ç•™è§†è§‰å¼ºè°ƒ)
        // ä¸ç§»é™¤ç²—ä½“ï¼Œè®©ç”¨æˆ·ç•Œé¢æ˜¾ç¤ºè‡ªç„¶å¼ºè°ƒ
        
        // 4. ä¿ç•™æ–œä½“æ ‡è®° *text* -> text (ä¿ç•™è§†è§‰å¼ºè°ƒ)
        // ä¸ç§»é™¤æ–œä½“ï¼Œä¿æŒæ–‡æœ¬çš„è‡ªç„¶é£æ ¼
        
        // 5. ä¿ç•™æ ‡é¢˜æ ‡è®°ä½†ç®€åŒ– #ã€##ã€### ç­‰ -> ä¿æŒç¼©è¿›ç»“æ„
         // å°†æ ‡é¢˜è½¬æ¢ä¸ºå¸¦ç¼©è¿›çš„æ®µè½ï¼Œä¿æŒå±‚æ¬¡ç»“æ„ï¼Œå¹¶åœ¨æ ‡é¢˜åæ·»åŠ æ¢è¡Œ
         // å¦‚æœæ ‡é¢˜ä¸­åŒ…å«*å­—ç¬¦ï¼Œç”¨ç©ºæ ¼æ›¿æ¢
         plainText = plainText.replace(/^###\s+(.*)$/gm, function(match, title) {
           return '    ' + title.replace(/\*/g, ' ') + '\n    ';  // ä¸‰çº§æ ‡é¢˜ -> 4ç©ºæ ¼ç¼©è¿› + æ ‡é¢˜(*æ›¿æ¢ä¸ºç©ºæ ¼) + æ¢è¡Œ + ç¼©è¿›
         });
         plainText = plainText.replace(/^##\s+(.*)$/gm, function(match, title) {
           return '  ' + title.replace(/\*/g, ' ') + '\n  ';  // äºŒçº§æ ‡é¢˜ -> 2ç©ºæ ¼ç¼©è¿› + æ ‡é¢˜(*æ›¿æ¢ä¸ºç©ºæ ¼) + æ¢è¡Œ + ç¼©è¿›
         });
         plainText = plainText.replace(/^#\s+(.*)$/gm, function(match, title) {
           return title.replace(/\*/g, ' ') + '\n  ';  // ä¸€çº§æ ‡é¢˜ -> æ ‡é¢˜(*æ›¿æ¢ä¸ºç©ºæ ¼) + æ¢è¡Œ + ç¼©è¿›
         });
        
        // 6. ä¿ç•™åˆ—è¡¨ç»“æ„ä½†ç®€åŒ–ç¬¦å·
        // æ— åºåˆ—è¡¨ -ã€*ã€+ -> ä¿æŒç¼©è¿›ä½†ç§»é™¤ç¬¦å·
        plainText = plainText.replace(/^\s*[-*+]\s+/gm, '  â€¢ ');  // æ— åºåˆ—è¡¨ -> åœ†ç‚¹
        // æœ‰åºåˆ—è¡¨ä¿æŒæ•°å­—ä½†ç®€åŒ–æ ¼å¼
        plainText = plainText.replace(/^\s*(\d+)\.\s+/gm, '  $1. ');  // æœ‰åºåˆ—è¡¨ -> ä¿æŒæ•°å­—
        
        // 7. ç§»é™¤ä»£ç å—æ ‡è®° ```ï¼Œä½†ä¿ç•™ä»£ç å†…å®¹
        plainText = plainText.replace(/```/g, '');
        
        // 8. æ¸…ç†å¤šä½™çš„ç©ºè¡Œï¼Œä½†ä¿æŒæ®µè½é—´è·
        plainText = plainText.replace(/\n{4,}/g, '\n\n\n');  // æœ€å¤šä¿ç•™3ä¸ªç©ºè¡Œ
        
        // 9. å»é™¤é¦–å°¾ç©ºç™½
        plainText = plainText.trim();
        
        return plainText;
      }
      
      // æ™ºèƒ½å¯¼è¯Šå“åº”å¤„ç†å‡½æ•° - ä½¿ç”¨åç«¯ä»£ç†API
      async function getMedicalResponse(userMessage) {
        // ä½¿ç”¨å…¨å±€userIdè€Œä¸æ˜¯æ¯æ¬¡ç”Ÿæˆæ–°çš„
        console.log('è°ƒç”¨getMedicalResponseå‡½æ•°ï¼Œç”¨æˆ·ID:', userId);
        
        try {
          // ä½¿ç”¨FormDataæ ¼å¼å‘é€è¯·æ±‚
          const formData = new FormData();
          formData.append('query', userMessage);
          formData.append('user', userId);
          
          // å¦‚æœæœ‰ä¼šè¯IDï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
          if (conversationId) {
            formData.append('conversation_id', conversationId);
            console.log('æ·»åŠ ä¼šè¯IDåˆ°è¯·æ±‚');
          }
          
          console.log('å‡†å¤‡å‘é€APIè¯·æ±‚åˆ°/api/dify/chat');
          
          const response = await fetch('/api/dify/chat', {
            method: 'POST',
            body: formData
          });
          
          console.log('APIè¯·æ±‚è¿”å›ï¼ŒçŠ¶æ€ç :', response.status);
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('APIè¯·æ±‚å¤±è´¥:', errorData);
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${errorData.error || response.status}`);
          }
          
          const data = await response.json();
          console.log('APIå“åº”æ•°æ®:', data);
          
          // æ›´æ–°ä¼šè¯ID
          if (data.conversation_id) {
            console.log('æ›´æ–°ä¼šè¯ID:', data.conversation_id);
            conversationId = data.conversation_id;
          }
          
          // è¿”å›å“åº”å†…å®¹
          const replyContent = data.content?.text || data.answer || '';
          console.log('è¿”å›å“åº”å†…å®¹:', replyContent);
          return replyContent;
        } catch (error) {
          console.error('Dify APIè°ƒç”¨å¤±è´¥:', error);
          console.error('é”™è¯¯ç±»å‹:', error.name);
          console.error('é”™è¯¯ä¿¡æ¯:', error.message);
          // å¤±è´¥æ—¶è¿”å›å¤‡ç”¨å“åº”
          return getFallbackResponse(userMessage);
        }
      }
      
      // å¤‡ç”¨å“åº”ç”Ÿæˆï¼ˆå½“APIä¸å¯ç”¨æ—¶ï¼‰
      function getFallbackResponse(userInput) {
        // å¢å¼ºçš„æ¨¡æ‹Ÿå“åº”é€»è¾‘ä½œä¸ºå¤‡ç”¨
        const responses = {
          'å¤´ç—›': 'æ ¹æ®æ‚¨æè¿°çš„å¤´ç—›ç—‡çŠ¶ï¼Œæˆ‘å»ºè®®æ‚¨å¯ä»¥è€ƒè™‘ä»¥ä¸‹ç§‘å®¤ï¼š\n1. ç¥ç»å†…ç§‘ - å¤´ç—›é€šå¸¸æ˜¯ç¥ç»ç³»ç»Ÿç›¸å…³é—®é¢˜\n2. å…¨ç§‘åŒ»å­¦ç§‘ - å¯ä»¥è¿›è¡Œåˆæ­¥è¯„ä¼°\n\nå»ºè®®æ‚¨è®°å½•å¤´ç—›çš„é¢‘ç‡ã€æŒç»­æ—¶é—´ã€ä¸¥é‡ç¨‹åº¦ä»¥åŠæ˜¯å¦ä¼´æœ‰å…¶ä»–ç—‡çŠ¶ï¼ˆå¦‚æ¶å¿ƒã€å‘•åã€è§†åŠ›æ¨¡ç³Šç­‰ï¼‰ï¼Œè¿™äº›ä¿¡æ¯å¯¹åŒ»ç”Ÿçš„è¯Šæ–­ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚',
          'å‘çƒ§': 'å‘çƒ­æ˜¯èº«ä½“çš„é˜²å¾¡ååº”ï¼Œæ ¹æ®æ‚¨çš„æƒ…å†µï¼Œå»ºè®®è€ƒè™‘ï¼š\n1. å…¨ç§‘åŒ»å­¦ç§‘ - è¿›è¡Œåˆæ­¥è¯„ä¼°å’Œæ£€æŸ¥\n2. æ„ŸæŸ“ç§‘ - å¦‚æœä¼´æœ‰æ˜æ˜¾æ„ŸæŸ“ç—‡çŠ¶\n\nè¯·æ³¨æ„æµ‹é‡ä½“æ¸©ï¼Œå¦‚æœä½“æ¸©è¶…è¿‡38.5â„ƒæˆ–æŒç»­å‘çƒ­è¶…è¿‡3å¤©ï¼Œå»ºè®®ç«‹å³å°±åŒ»ã€‚åŒæ—¶æ³¨æ„è¡¥å……æ°´åˆ†ï¼Œå¤šä¼‘æ¯ã€‚',
          'è…¹ç—›': 'è…¹ç—›å¯èƒ½æ¶‰åŠå¤šä¸ªå™¨å®˜ç³»ç»Ÿï¼Œå»ºè®®è€ƒè™‘ï¼š\n1. æ¶ˆåŒ–å†…ç§‘ - èƒƒè‚ é“é—®é¢˜æœ€å¸¸è§\n2. æ™®å¤–ç§‘ - å¦‚æœç–¼ç—›å‰§çƒˆæˆ–æŒç»­\n\nè¯·è§‚å¯Ÿæ˜¯å¦æœ‰å…¶ä»–ä¼´éšç—‡çŠ¶ï¼Œå¦‚å‘•åã€è…¹æ³»ã€å‘çƒ­ç­‰ï¼Œå¹¶è®°å½•ç–¼ç—›çš„éƒ¨ä½ã€æ€§è´¨å’ŒæŒç»­æ—¶é—´ï¼Œè¿™äº›ä¿¡æ¯å¯¹åŒ»ç”Ÿçš„è¯Šæ–­å¾ˆé‡è¦ã€‚',
          'å’³å—½': 'å’³å—½æ˜¯å¸¸è§ç—‡çŠ¶ï¼Œå¯èƒ½ä¸å¤šç§åŸå› æœ‰å…³ï¼š\n1. å‘¼å¸å†…ç§‘ - å‘¼å¸é“æ„ŸæŸ“æœ€å¸¸è§\n2. è€³é¼»å–‰ç§‘ - å¦‚æœä¼´æœ‰å–‰å’™ç—›æˆ–é¼»å¡\n\nè¯·æ³¨æ„å’³å—½æ˜¯å¦æœ‰ç—°ï¼Œç—°çš„é¢œè‰²å’Œæ€§è´¨ï¼Œä»¥åŠæ˜¯å¦ä¼´æœ‰å‘çƒ­ã€èƒ¸ç—›ç­‰ç—‡çŠ¶ï¼Œè¿™äº›ä¿¡æ¯æœ‰åŠ©äºåŒ»ç”Ÿåˆ¤æ–­ç—…å› ã€‚',
          'èƒ¸é—·': 'èƒ¸é—·å¯èƒ½ä¸å¿ƒè„æˆ–å‘¼å¸ç³»ç»Ÿæœ‰å…³ï¼Œå»ºè®®è€ƒè™‘ï¼š\n1. å¿ƒè¡€ç®¡å†…ç§‘ - æ’é™¤å¿ƒè„ç›¸å…³é—®é¢˜\n2. å‘¼å¸å†…ç§‘ - æ£€æŸ¥å‘¼å¸ç³»ç»Ÿ\n\nå¦‚æœèƒ¸é—·ç—‡çŠ¶ä¸¥é‡æˆ–ä¼´æœ‰èƒ¸ç—›ã€å‘¼å¸å›°éš¾ï¼Œå»ºè®®ç«‹å³å°±åŒ»ã€‚',
          'æ¶å¿ƒ': 'æ¶å¿ƒå¯èƒ½ä¸æ¶ˆåŒ–ç³»ç»Ÿæœ‰å…³ï¼Œå»ºè®®è€ƒè™‘ï¼š\n1. æ¶ˆåŒ–å†…ç§‘ - æ£€æŸ¥èƒƒè‚ é“é—®é¢˜\n2. å…¨ç§‘åŒ»å­¦ç§‘ - è¿›è¡Œåˆæ­¥è¯„ä¼°\n\nè¯·æ³¨æ„è§‚å¯Ÿæ˜¯å¦æœ‰å‘•åã€è…¹ç—›ç­‰ä¼´éšç—‡çŠ¶ï¼Œè¿™äº›ä¿¡æ¯å¯¹è¯Šæ–­å¾ˆæœ‰å¸®åŠ©ã€‚',
          'å¤±çœ ': 'é•¿æœŸå¤±çœ å¯èƒ½å½±å“å¥åº·ï¼Œå»ºè®®è€ƒè™‘ï¼š\n1. ç¥ç»å†…ç§‘ - ç¥ç»ç³»ç»Ÿç›¸å…³\n2. å¿ƒç†ç§‘ - æƒ…ç»ªå’Œå¿ƒç†å› ç´ \n\nä¿æŒè§„å¾‹ä½œæ¯ï¼Œç¡å‰é¿å…ä½¿ç”¨ç”µå­è®¾å¤‡ï¼Œé€‚å½“è¿åŠ¨å¯èƒ½æœ‰åŠ©äºæ”¹å–„ç¡çœ ã€‚',
          'ä½é™¢': 'ä½é™¢æµç¨‹é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š\n1. åŒ»ç”Ÿå¼€å…·ä½é™¢è¯æ˜\n2. å‰å¾€ä½é™¢å¤„åŠç†å…¥é™¢æ‰‹ç»­\n3. ç¼´çº³ä½é™¢æŠ¼é‡‘\n4. å…¥ä½ç—…æˆ¿å¹¶æ¥å—æŠ¤ç†è¯„ä¼°\n\nä»¥ä¸‹æ˜¯è¯¦ç»†çš„ä½é™¢æµç¨‹å›¾ï¼š\n<img src="https://cdn-mineru.openxlab.org.cn/result/2025-08-29/ce264a78-3b3b-4886-90ac-c7389ac9b8fa/c3b2efaa6bfa35f0a45afa4b66fff1f192436922b38bc127bf89d6612f39c62fb.jpg" alt="ä½é™¢æµç¨‹å›¾" class="chat-image" />'
        };
        
        // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„å…³é”®è¯
        for (const [keyword, response] of Object.entries(responses)) {
          if (userInput.includes(keyword)) {
            return response + '\n\n(ç³»ç»Ÿæç¤ºï¼šå½“å‰ä½¿ç”¨æ™ºèƒ½å¯¼è¯Šå¤‡ç”¨ç³»ç»Ÿï¼Œå»ºè®®åç»­æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–APIæœåŠ¡çŠ¶æ€ã€‚)';
          }
        }
        
        // é»˜è®¤å“åº”
        return `æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ã€‚æ ¹æ®æ‚¨æè¿°çš„"${userInput}"ç—‡çŠ¶ï¼Œæˆ‘å»ºè®®æ‚¨å¯ä»¥è€ƒè™‘ä»¥ä¸‹ç§‘å®¤ï¼š
1. å…¨ç§‘åŒ»å­¦ç§‘ - è¿›è¡Œåˆæ­¥è¯„ä¼°
2. ç›¸å…³ä¸“ç§‘ - æ ¹æ®å…·ä½“ç—‡çŠ¶å¯èƒ½éœ€è¦åˆ°ä¸“ç§‘å°±è¯Š

å»ºè®®æ‚¨åˆ°åŒ»é™¢å°±è¯Šæ—¶ï¼Œå¯ä»¥å…ˆåˆ°å¯¼è¯Šå°è¿›è¡Œåˆæ­¥å’¨è¯¢ï¼Œä»¥ä¾¿è·å¾—æ›´ç²¾å‡†çš„ç§‘å®¤æ¨èã€‚å¦‚æœç—‡çŠ¶ä¸¥é‡æˆ–æŒç»­ä¸ç¼“è§£ï¼Œè¯·åŠæ—¶å°±åŒ»ã€‚

(ç³»ç»Ÿæç¤ºï¼šå½“å‰ä½¿ç”¨æ™ºèƒ½å¯¼è¯Šå¤‡ç”¨ç³»ç»Ÿï¼Œå»ºè®®åç»­æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–APIæœåŠ¡çŠ¶æ€ã€‚)`;
      }
      

        
      
    </script>
  </body>
</html>